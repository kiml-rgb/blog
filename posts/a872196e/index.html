<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Kiml">
    
    <title>
        
            面试 MQ |
        
        Kiml&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/sword.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"kiml.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"title":"Kiml's Blog","author":"Kiml","avatar":null,"font_size":null,"font_family":null,"primary_color":"#0066cc","logo":null,"favicon":"/images/sword.png"},"menu":{"Home":"/","Archives":"/archives","Tags":"/tags","Categories":"/categories","tools":"/tools/","About":"/about"},"first_screen":{"enable":true,"header_transparent":true,"background_img":"https://blog-resources.oss-cn-hangzhou.aliyuncs.com/240414/%E8%83%8C%E6%99%AF.webp","description":"我生来就是高山而非溪流 || 我欲于群峰之巅俯视平庸的沟壑","font_color":null,"hitokoto":false},"social_contact":{"enable":true,"links":{"github":"https://github.com/kiml-rgb","email":"1162278448@qq.com"}},"scroll":{"progress_bar":true,"percent":true},"home":{"announcement":null,"category":false,"tag":false,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":true},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":true},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"obsidian"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"waline","valine":{"appid":"q1UTRN34B6O87bCsl1cg50tn-gzGzoHsz","appkey":"nwRaNMVMqNgK4gogSJCAyaUq","server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":"https://comment.kiml.site/","reaction":false,"version":3}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":true},"footer":{"since":2022,"icp":null,"site_deploy":{"enable":false,"provider":"github","url":null}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","home_article":{"category":{"enable":true,"limit":3},"tag":{"enable":true,"limit":5}},"source_data":{"tools":[{"category":"聊天 AI"},{"name":"ChatGPT","link":"https://chat.openai.com/","description":"OpenAI 旗下 AI 聊天对话工具","image":"/images/tools/chatgpt.ico"},{"name":"智谱清言","link":"https://chatglm.cn/","description":"智谱 AI 旗下的 AI 聊天对话工具","image":"/images/tools/Chat GLM.png"},{"name":"Kimi Chat","link":"https://kimi.moonshot.cn","description":"擅长长文本对话","image":"/images/tools/kimi.png"},{"category":"部署托管"},{"name":"Vercel","link":"https://vercel.com/","description":"Vercel","image":"/images/tools/Vercel.png"}]},"version":"4.1.3"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Keep Theme" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left border-box">
            
            <a class="site-name border-box" href="/">
               Kiml&#39;s Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc">
                <ul class="menu-list">
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                
                                首页
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                
                                归档
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                
                                标签
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                
                                分类
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/tools/"
                            >
                                
                                工具
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/"
                    >首页</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives"
                    >归档</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags"
                    >标签</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories"
                    >分类</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tools/"
                    >工具</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about"
                    >关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        面试 MQ
                    </div>
                

                
                    <div class="post-header border-box">
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Kiml</span>
                                
                                    <span class="author-badge">Lv5</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-08-22 11:39:33</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Sat Aug 24 2024 23:03:10 GMT+0800">2024-08-24 23:03:10</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li>
                        
                    
                            <li class="category-item">&nbsp;<i class="icon fas fa-angle-right"></i>&nbsp;<a href="/categories/%E9%9D%A2%E8%AF%95/%E5%85%AB%E8%82%A1%E6%96%87/">八股文</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E9%9D%A2%E8%AF%95/">面试</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%85%AB%E8%82%A1%E6%96%87/">八股文</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>5k 字</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>17 分钟</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    <ul class="lvl-0">
<li class="lvl-2">
<p>前言<br>
❗表示必掌握，❔表示基本不会问</p>
</li>
<li class="lvl-2">
<p>更新</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">24-08-22 初始记录</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="你知道目前市面上使用的-MQ-有哪些吗？">你知道目前市面上使用的 MQ 有哪些吗？</h2>
<p>RabbitMQ、RocketMQ、Kafka。</p>
<h3 id="你使用的是哪种-MQ？为什么选择这类-MQ-qps-？">你使用的是哪种 MQ？为什么选择这类 MQ(qps)？</h3>
<p>我们选用的是 RabbitMQ，它并发能力强，性能好，延时低，管理界面也很丰富，只是吞吐量较低，但对于不是特别依赖大数据的项目来说，选用 RabbitMQ 已经足够用了。</p>
<p>RocketMQ 是阿里开源项目，吞吐量是最高的（10 万次级），但免费版的 MQ 是阉割版的，容易出问题。</p>
<p>Kafka 吞吐量很大（10 万次级），但它不是真正的 MQ，只是类似 MQ 的产品，它只支持主要 MQ 功能，比如它不具有消息确认机制。</p>
<h3 id="什么是-RabbitMQ？">什么是 RabbitMQ？</h3>
<p>RabbitMQ 是一款开源的，Erlang 编写的，基于 AMQP 协议的消息中间件。</p>
<h4 id="什么是-AMQP-协议？">什么是 AMQP 协议？</h4>
<p>AMQP 一个提供统一消息服务的应用层标准高级消息队列的链接协议，RabbitMQ 是主要根据 AMQP 协议进行数据通信和传输的。有点类似于 HTTP 协议。</p>
<h4 id="AMPQ-与-JMS-有什么区别知道吗？">AMPQ 与 JMS 有什么区别知道吗？</h4>
<p>JMS 是定义了统一的接口（API），来对消息操作进行统一；AMQP 是通过规定协议来统一数据交互的格式。</p>
<p>JMS 限定了必须使用 Java 语言；AMQP 只是协议，不规定实现方式，因此是跨语言的。</p>
<p>JMS 规定了两种消息模式；而 AMQP 的消息模式更加丰富。</p>
<h2 id="你使用的是-SpringCloud，Feign-可以进行远程调用，为什么还要中间加一个-MQ-呢？">你使用的是 SpringCloud，Feign 可以进行远程调用，为什么还要中间加一个 MQ 呢？</h2>
<p>为了解耦，如果没有中间件进行处理，那两个系统之间的关系过于紧密，一方改动，另一方也必须改动。</p>
<h3 id="MQ-有哪些优势？">MQ 有哪些优势？</h3>
<ol>
<li class="lvl-3">
<p><strong>应用解耦（核心）：降低系统的耦合性，提升可维护性。</strong><br>
场景：服务调用之间都可以考虑 MQ。</p>
</li>
<li class="lvl-3">
<p><strong>异步提速：提升用户体验和系统吞吐量。</strong><br>
场景：发送订单消息、发送短信消息等。</p>
</li>
<li class="lvl-3">
<p><strong>削峰填谷：减少高峰时期对服务器的压力。</strong><br>
场景：秒杀活动、限时定购等。</p>
</li>
</ol>
<h2 id="RabbitMQ-有什么缺点？">RabbitMQ 有什么缺点？</h2>
<ol>
<li class="lvl-3">
<p><strong>系统可用性降低</strong><br>
本来系统运行好好的，现在你非要加入个消息队列进去，那消息队列挂了，你的系统不是呵呵了。因此，系统可用性会降低。</p>
</li>
<li class="lvl-3">
<p><strong>系统复杂度提高</strong><br>
加入了消息队列，要多考虑很多方面的问题，比如：一致性问题、如何保证消息不被重复消费、如何保证消息可靠性传输等。因此，需要考虑的东西更多，复杂性增大。</p>
</li>
<li class="lvl-3">
<p><strong>一致性问题</strong><br>
A 系统处理完了直接返回成功了，人都以为你这个请求就成功了；但是问题是，要是 BCD 三个系统那里，BD 两个系统写库成功了，结果 C 系统写库失败了，咋整？你这数据就不一致了。</p>
</li>
<li class="lvl-3">
<p><strong>消息顺序问题</strong><br>
如果有 A、B 两个消息，B 消息被消费者消费的前提是 A 消息已被执行，这时候就不能先执行 B，得先执行 A 才行。</p>
</li>
</ol>
<h3 id="那怎么解决以上缺点呢？">那怎么解决以上缺点呢？</h3>
<ol>
<li class="lvl-3">
<p><strong>系统可用性降低：集群模式保证高可用。</strong><br>
镜像集群模式：这种模式，才是所谓的 RabbitMQ 的高可用模式。跟普通集群模式不一样的是，在镜像集群模式下，你创建的 queue，无论元数据还是 queue 里的消息都会存在于多个实例上，就是说，每个 RabbitMQ 节点都有这个 queue 的一个完整镜像，包含 queue 的全部数据的意思。然后每次你写消息到 queue 的时候，都会自动把消息同步到多个实例的 queue 上。RabbitMQ 有很好的管理控制台，就是在后台新增一个策略，这个策略是镜像集群模式的策略，指定的时候是可以要求数据同步到所有节点的，也可以要求同步到指定数量的节点，再次创建 queue 的时候，应用这个策略，就会自动将数据同步到其他的节点上去了。这样的话，好处在于，你任何一个机器宕机了，没事儿，其它机器（节点）还包含了这个 queue 的完整数据，别的 consumer 都可以到其它节点上去消费数据。坏处在于，第一，这个性能开销也太大了吧，消息需要同步到所有机器上，导致网络带宽压力和消耗很重！RabbitMQ 一个 queue 的数据都是放在一个节点里的，镜像集群下，也是每个节点都放这个 queue 的完整数据。</p>
</li>
<li class="lvl-3">
<p><strong>系统复杂度提高</strong><br>
加入 Rabbit 确实会增加系统复杂度，但 MQ 的解耦、提速、削峰这些方面的收益超过管理 MQ 的成本，所以该用还得用。</p>
</li>
<li class="lvl-3">
<p><strong>一致性问题</strong><br>
RabbitMQ 分布式消息是最终一致性的，即使可能因为消息失败而导致前后消息不一致，但分布式系统是在不同服务器上的，不能像简单的本地回滚一样，所以它通过发送延迟消息和定时消息来进行消息补偿，保证最终消息是一致性的，即是一个完整的事务。<br>
RabbitMQ 本身是有事务的功能的，但是分布式的事务处理效率太低，且发生问题的可能性不高，所以多是选择放弃强一致性，而采用最终一致性。</p>
</li>
<li class="lvl-3">
<p><strong>消息顺序问题</strong><br>
在 MQ 中将有顺序要求的 AB 两个消息分别用两个队列与两个消费端手工 ack 接收，并且在消息上需要有对应的同组编号信息，以及发送次数，如果 B 执行的前提是已经消费了 A，那需要在消费端判断 A 消息是否已经正确接收（也就是查询成功的消息库）。如果 A 已经消费成功，则消费 B，如果 A 消费失败，或者 A 还没有消费，则 B 消息也直接返回为消息失败，并且不重回队列。并且让消息提供方重新发送 AB 消息，如果连续三次发送消息仍然消费失败，则 AB 两个消息第四次处理时就扔入死信队列中，等待人工处理。</p>
</li>
</ol>
<h3 id="RabbitMQ-事务是怎么实现的？">RabbitMQ 事务是怎么实现的？</h3>
<p>事务的实现主要是对信道（Channel）的设置，主要的方法有三个：</p>
<ol>
<li class="lvl-3">
<p>channel.txSelect() 声明启动事务模式；</p>
</li>
<li class="lvl-3">
<p>channel.txComment() 提交事务；</p>
</li>
<li class="lvl-3">
<p>channel.txRollback() 回滚事务；</p>
</li>
</ol>
<h2 id="RabbitMQ-的实现原理是怎么样子的？">RabbitMQ 的实现原理是怎么样子的？</h2>
<p>首先，消息提供方会和 RabbitMQ 之间建立起 TCP 连接（Connection），每个连接中会有多个通信的信道（channel）来提连通信效率，不同的信道之间通过信道 id 来实现信息隔离。</p>
<p>而在 RabbitMQ 中，消息提供者发出的消息会先到 RabbitMQ 中的交换机中，由交换机根据分发规则，通过队列的形式分发消息。</p>
<p>消息接收方与 RabbitMQ 之间也一样是通过 TCP 连接和信道建立连接和通信。</p>
<p>此外，在 RabbitMQ 中，交换机与队列之间不同的边接方式，也产生了不同的工作模式。</p>
<h3 id="RabbitMQ-有哪些工作模式？">RabbitMQ 有哪些工作模式？</h3>
<ol>
<li class="lvl-3">
<p>简单模式：就是不通过交换机，消息直接通过队列，一对一收发。</p>
</li>
<li class="lvl-3">
<p>工作队列模式：也是不通过交换机，消息直接通过队列，只是一个发送方可以有多个接收端。</p>
</li>
<li class="lvl-3">
<p>发布订阅模式：由交换机分发消息到不同队列，每个消费者只监听自己的队列。</p>
</li>
<li class="lvl-3">
<p>路由模式：由交换机分发消息，但是发送方需要指定路由 key，交换机会根据不同的 routing key 分发给不同的队列，消费方对应自己需要的队列。</p>
</li>
<li class="lvl-3">
<p>通配符模式：和路由模式有些相近，只是通配符模式可以在绑定 routing key 时使用通配符。</p>
</li>
<li class="lvl-3">
<p>RPC 模式：RPC 远程调用模式，严格来说不太算是 MQ。</p>
</li>
</ol>
<h4 id="为什么-RPC-严格来说不能算是-MQ？">为什么 RPC 严格来说不能算是 MQ？</h4>
<p>RPC，远程过程调用，实际上是一种技术思想，而一种规范或协议，一般来说 RPC 远程调用是同步通信的，且 RPC 模式是没有队列的，多用在立即等待返回处理结果的场景，比如使用基于 RPC 思想的 Dubbo。而 MQ 是用来异步提速的，所以严格来说，RPC 模式不能算是 MQ。</p>
<h4 id="消息怎么路由？">消息怎么路由？</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>消息提供方 -&gt;路由 -&gt;一至多个队列消息发布到交换器时，消息将拥有一个路由键（routing key），在消息创建时设定。通过队列路由键，可以把队列绑定到交换器上。消息到达交换器后，RabbitMQ 会将消息的路由键与队列的路由键进行匹配（针对不同的交换器有不同的路由规则）；</p>
</li>
<li class="lvl-2">
<p>常用的交换器主要分为一下三种：</p>
<ul class="lvl-2">
<li class="lvl-6">fanout：如果交换器收到消息，将会广播到所有绑定的队列上。</li>
<li class="lvl-6">direct：如果路由键完全匹配，消息就被投递到相应的队列。</li>
<li class="lvl-6">topic：可以使来自不同源头的消息能够到达同一个队列。 使用 topic 交换器时，可以使用通配符。</li>
</ul>
</li>
</ul>
<h4 id="消息基于什么传输？">消息基于什么传输？</h4>
<p>由于 TCP 连接的创建和销毁开销较大，且并发数受系统资源限制，会造成性能瓶颈。RabbitMQ 使用信道的方式来传输数据。信道是建立在真实的 TCP 连接内的虚拟连接，且每条 TCP 连接上的信道数量没有限制。</p>
<h2 id="RabbitMQ-中的交换机可以储存消息吗？">RabbitMQ 中的交换机可以储存消息吗？</h2>
<p>不可以。交换机只负责转发消息，不具备存储消息的能力。</p>
<h2 id="如何防止消息丢失呢？">如何防止消息丢失呢？</h2>
<ol>
<li class="lvl-3">
<p>在生产者丢失——confirm 确认模式</p>
<ol>
<li class="lvl-7">使用 RabbitMQ 事务机制，但它是同步的，且很耗性能。</li>
<li class="lvl-7">开启 confirm 确认模式，确认消息是否从“生产者”发送到“交换机”，成功回传 ack 消息，失败可以重试或抛异常。且 confirm 模式是异步回调接口通知 MQ 是否接收到消息。一般都采用这种方式。</li>
</ol>
</li>
<li class="lvl-3">
<p>在 MQ 中丢失——持久化</p>
<ol>
<li class="lvl-7">开启 RabbitMQ 持久化，防止 RabbitMQ 自己弄丢数据。除非极小概率还没来得及持久化，MQ 就先挂了，即使这样，也只会丢失极少的数据量。</li>
<li class="lvl-7">所以，持久化可以跟生产者那边的 confirm 机制配合起来，只有消息被持久化到磁盘之后，才会通知生产者 ack 了，所以哪怕是在持久化到磁盘之前，RabbitMQ 挂了，数据丢了，生产者收不到 ack，你也是可以自己重发的。</li>
<li class="lvl-7">但持久化的过程也是很耗性能的。</li>
</ol>
</li>
<li class="lvl-3">
<p>在消费者丢失——ack 机制</p>
<ol>
<li class="lvl-7">用 RabbitMQ 提供的 ack 机制，简单来说，就是你必须关闭 RabbitMQ 的自动 ack，可以通过一个 api 来调用就行，然后每次你自己代码里确保处理完的时候，再在程序里 ack 一把。这样的话，如果你还没处理完，不就没有 ack 了？那 RabbitMQ 就认为你还没处理完，这个时候 RabbitMQ 会把这个消费分配给别的 consumer 去处理，消息是不会丢的。以上三种方式，只是防止丢失，但具体补消息，还需要靠消息的补偿机制（也就是消息的可靠性保证）。</li>
</ol>
</li>
</ol>
<h2 id="❗RabbitMQ-如何保证消息的可靠性呢？">❗RabbitMQ 如何保证消息的可靠性呢？</h2>
<p>消息补偿。（延迟消息 + 定时扫描）</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>由生产者发送消息给 MQ，MQ 会将消息给到消费者，消息者收到消息后，会返回一个消息确认，这个“消息确认”会被 MQ 放到“回调检查服务”中，“回调检查服务”会将收到的消息给到定时检查的 MDB。</p>
</li>
<li class="lvl-2">
<p>但在这个过程中，如果出现异常或者网络波动，就会导致消息到不了回调检查服务，所以为了保证能够消息可靠性，会由生产者延迟一段时间后，再发送一个相同的消息给 MQ，这个消息会直接被 MQ 发送到回调检查服务。</p>
</li>
<li class="lvl-2">
<p>回调检查服务会将延迟发送的消息和 MDB 中的消息对比，如果 MDB 中没有该消息，就会调用生产者，让生产者重新发送消息。</p>
</li>
<li class="lvl-2">
<p>但在以上过程，还可能出现“延迟发送消息”也出问题，为了更深层保证消息的可靠性，还需要一个定时检查服务，每隔一段固定时间，定时检查服务会将 MDB 里的消息和 DB 中的消息进行匹配（检查某个时间段的表，而不是全表扫描），如果有 MDB 缺失的消息，就会调用生产者重新发送消息。</p>
</li>
</ul>
<h2 id="什么是-TTL？什么是死信队列，消息成为死信有哪几种情况？什么是延迟队列？">什么是 TTL？什么是死信队列，消息成为死信有哪几种情况？什么是延迟队列？</h2>
<ul class="lvl-0">
<li class="lvl-2">
<p>TTL：全称 Time To Live（存活时间/过期时间）</p>
<ol>
<li class="lvl-7">如果给消息设置过期时间，即使到了过期时间，消息也不会立马被清除，只有等消息到了队列的头上，才会被判断是否过期清除。</li>
<li class="lvl-7">如果给整个队列设置过期时间，即每一个进入队列的消息，都会各自被设置为了相同的过期时间。而非整个队列定时隔一段时间清除。</li>
<li class="lvl-7">如果单独消息和整个队列两则都设置了过期时间，以时间短的为准。</li>
</ol>
</li>
<li class="lvl-2">
<p>死信队列：英文缩写：DLX  。Dead Letter Exchange（死信交换机）</p>
<ul class="lvl-2">
<li class="lvl-6">消息成为死信的三种情况：
<ol>
<li class="lvl-11">队列消息长度到达限制；</li>
<li class="lvl-11">消费者拒接消费消息，basicNack/basicReject,并且不把消息重新放入原目标队列，requeue=false；</li>
<li class="lvl-11">原队列存在消息过期设置，消息到达超时时间未被消费；</li>
</ol>
</li>
</ul>
</li>
<li class="lvl-2">
<p>延迟队列：即消息进入队列后不会立即被消费，只有到到达指定时间后，才会被消费。</p>
<ul class="lvl-2">
<li class="lvl-6">RabbitMQ 中并未提供延迟队列功能，采用【TTL】+【死信队列】 组合实现延迟队列的效果。</li>
</ul>
</li>
</ul>
<h2 id="有几百万消息持续积压几小时，说说怎么解决？">有几百万消息持续积压几小时，说说怎么解决？</h2>
<p>消息积压处理办法：临时紧急扩容：</p>
<p>先修复 consumer 的问题，确保其恢复消费速度，然后将现有 consumer 都停掉。</p>
<p>临时建立好原先 10 倍的 queue 数量。</p>
<p>然后写一个临时的分发数据的 consumer 程序，这个程序部署上去消费积压的数据，消费之后不做耗时的处理，直接均匀轮询写入临时建立好的 10 倍数量的 queue。</p>
<p>接着临时征用 10 倍的机器来部署 consumer，每一批 consumer 消费一个临时 queue 的数据。这种做法相当于是临时将 queue 资源和 consumer 资源扩大 10 倍，以正常的 10 倍速度来消费数据。</p>
<p>等快速消费完积压数据之后，得恢复原先部署的架构，重新用原先的 consumer 机器来消费消息。</p>
<h2 id="消息队列满了以后该怎么处理">消息队列满了以后该怎么处理</h2>
<p>没办法了，说明紧急扩容也来不及了，只能“丢弃 + 批量重导”了，写程序快速消费，然后重导。</p>
<h2 id="RabbitMQ-如何保证消息的不重复消费呢？【重要】">RabbitMQ 如何保证消息的不重复消费呢？【重要】</h2>
<p>一条数据重复出现两次，数据库里就只有一条数据，这就是保证了系统的幂等性。</p>
<p>保障了消息的幂等性，同一条消息被重复消费也就不影响了，因为不影响最终执行结果。</p>
<ol>
<li class="lvl-3">
<p>方法一：采用乐观锁机制保证消息幂等性。在数据库中会增加一个版本字段，执行时也会匹配版本，如果版本不一致，SQL 语句的匹配就不成立，就不会执行。</p>
</li>
<li class="lvl-3">
<p>方法二：你拿到这个消息做数据库的 insert 操作，那就容易了，给这个消息做一个唯一的主键，那么就算出现重复消费的情况，就会导致主键冲突，避免数据库出现脏数据。</p>
</li>
<li class="lvl-3">
<p>方法三：你拿到这个消息做 redis 的 set 的操作，那就容易了，不用解决，因为你无论 set 几次结果都是一样的，set 操作本来就算幂等操作。</p>
</li>
<li class="lvl-3">
<p>方法四：如果上面两种情况还不行，上大招。准备一个第三方介质，来做消费记录。以 redis 为例，给消息分配一个全局 id，只要消费过该消息，将 <code>&lt;id,message&gt;</code> 以 K-V 形式写入 redis。那消费者开始消费前，先去 redis 中查询有没有消费记录即可，先根据这个 id 去比如 redis 里查一下，之前消费过吗？如果没有消费过，你就处理，然后这个 id 写 redis。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。</p>
</li>
</ol>
<h2 id="如何解决消息队列的延时以及过期失效问题？">如何解决消息队列的延时以及过期失效问题？</h2>
<p>假设你用的是 RabbitMQ，RabbtiMQ 是可以设置过期时间的，也就是 TTL。如果消息在 queue 中积压超过一定的时间就会被 RabbitMQ 给清理掉，这个数据就没了。这就不是说数据会大量积压在 mq 里，而是大量的数据会直接搞丢。</p>
<p>我们可以采取一个方案，就是批量重导，这个我们之前线上也有类似的场景干过。就是大量积压的时候，我们当时就直接丢弃数据了，然后等过了高峰期以后，比如大家一起喝咖啡熬夜到晚上 12 点以后，用户都睡觉了。这个时候我们就开始写程序，将丢失的那批数据（发送的数据库和确认接收的数据库匹配），写个临时程序，一点一点的查出来，然后重新灌入 mq 里面去，把白天丢的数据给他补回来。也只能是这样了。</p>
<p>假设 1 万个订单积压在 mq 里面，没有处理，其中 1000 个订单都丢了，你只能手动写程序把那 1000 个订单给查出来，手动发到 mq 里去再补一次。</p>
<h2 id="如果要你自己设计一个-MQ，你会怎么设计？">如果要你自己设计一个 MQ，你会怎么设计？</h2>
<ol>
<li class="lvl-3">
<p>重启起一个服务器来（使用 Redis）充当 RabbitMQ，实现 MQ 的解耦功能。</p>
</li>
<li class="lvl-3">
<p>这个服务器需要可以存储和转发消息，存储是为了实现永久化，防止服务器出问题，消息丢失；转发消息则是可以通过不同队列来实现指定消费端，实现异步提速功能和削峰填谷的功能。</p>
</li>
<li class="lvl-3">
<p>建立消息补尝机制，防止消息丢失。</p>
</li>
</ol>
<h3 id="怎么使用-Redis-实现-MQ-功能呢？">怎么使用 Redis 实现 MQ 功能呢？</h3>
<ol>
<li class="lvl-3">
<p>使用 list 类型保存数据信息，rpush 生产消息，lpop 消费消息，当 lpop 没有消息时，可以 sleep 一段时间，然后再检查有没有信息，如果不想 sleep 的话，可以使用 blpop, 在没有信息的时候，会一直阻塞，直到信息的到来。redis 可以通过 pub/sub 主题订阅模式实现一个生产者，多个消费者，当然也存在一定的缺点，当消费者下线时，生产的消息会丢失。</p>
</li>
<li class="lvl-3">
<p>使用 sortedset，使用时间戳做 score, 消息内容作为 key，调用 zadd 来生产消息，消费者使用 zrangbyscore 获取 n 秒之前的数据做轮询处理。</p>
</li>
</ol>

                </div>
                
                        
<div class="post-copyright-info-container border-box">
    <div class="copyright-info-content border-box">
        <div class="copyright-info-top border-box">
            <div class="copyright-post-title border-box text-ellipsis">
                面试 MQ
            </div>

            <div class="copyright-post-link border-box text-ellipsis">
                posts/a872196e/
            </div>
        </div>

        <div class="copyright-info-bottom border-box">
            <div class="copyright-post-author bottom-item">
                <div class="type">
                    作者
                </div>
                <div class="content">Kiml</div>
            </div>

            <div class="post-time bottom-item">
                <div class="type">
                    发布于
                </div>
                <div class="content">2024-08-22 11:39</div>
            </div>


            <div class="post-license bottom-item">
                <div class="type">
                    许可
                </div>
                <div class="content tooltip" data-tooltip-content="CC BY-NC-SA 4.0">
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank">
                        
                            <i class="fa-brands fa-creative-commons"></i>
                            <i class="fa-brands fa-creative-commons-by"></i>
                            <i class="fa-brands fa-creative-commons-nc"></i>
                            <i class="fa-brands fa-creative-commons-sa"></i>
                        
                    </a>
                </div>
            </div>
        </div>

        <i class="copyright-bg fa-solid fa-copyright"></i>
    </div>
    <div class="copy-copyright-info flex-center tooltip" data-tooltip-content="复制版权信息" data-tooltip-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E9%9D%A2%E8%AF%95/">面试</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%85%AB%E8%82%A1%E6%96%87/">八股文</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/posts/60f8da4b/"
                                   title="Jenkins + k8s 实现 CICD（持续集成和持续部署）"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Jenkins + k8s 实现 CICD（持续集成和持续部署）</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/posts/f5b0876a/"
                                   title="跨域产生的原因及解决方案"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">跨域产生的原因及解决方案</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;评论
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">评论插件加载失败</span>
    <button class="reload keep-button">点击重新加载</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">正在加载评论插件</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="waline-comment-container">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/waline/3.2.1/waline.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/waline/3.2.1/waline-meta.css"/>
        <div id="waline-comment"></div>
        <script data-pjax>
          window.KeepCommentPlugin.walineOptions = JSON.parse('{}'.replace(/&#34;/g, '"'))
          window.KeepCommentPlugin.walineOptions.el = '#waline-comment'
          window.KeepCommentPlugin.walineOptions.comment = '.post-comments-count'
          window.KeepCommentPlugin.walineOptions.serverURL = 'https://comment.kiml.site/'
          window.KeepCommentPlugin.walineOptions.lang = 'zh-CN' || 'zh-CN'
          window.KeepCommentPlugin.walineOptions.reaction = 'false' === 'true'
        </script>

        

        
            <script data-pjax
                    async
                    type="module"
            >
              import { init } from 'https://cdnjs.cloudflare.com/ajax/libs/waline/3.2.1/waline.js'
              window.KeepCommentPlugin.initWaline = () => {
                if (init) {
                  init(window.KeepCommentPlugin.walineOptions)
                  window.KeepCommentPlugin.hideLoading()
                } else {
                  setTimeout(() => {
                    window.KeepCommentPlugin.initWaline()
                  }, 1000)
                }
              }

              if ('true' === 'true') {
                setTimeout(() => {
                  window.KeepCommentPlugin.initWaline()
                }, 1200)
              } else {
                window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initWaline)
              }
            </script>
        
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <!-- use hexo-blog-encrypt -->
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%A0%E7%9F%A5%E9%81%93%E7%9B%AE%E5%89%8D%E5%B8%82%E9%9D%A2%E4%B8%8A%E4%BD%BF%E7%94%A8%E7%9A%84-MQ-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%90%97%EF%BC%9F"><span class="nav-text">你知道目前市面上使用的 MQ 有哪些吗？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%A0%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AF%E5%93%AA%E7%A7%8D-MQ%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9%E8%BF%99%E7%B1%BB-MQ-qps-%EF%BC%9F"><span class="nav-text">你使用的是哪种 MQ？为什么选择这类 MQ(qps)？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-RabbitMQ%EF%BC%9F"><span class="nav-text">什么是 RabbitMQ？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-AMQP-%E5%8D%8F%E8%AE%AE%EF%BC%9F"><span class="nav-text">什么是 AMQP 协议？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AMPQ-%E4%B8%8E-JMS-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%E7%9F%A5%E9%81%93%E5%90%97%EF%BC%9F"><span class="nav-text">AMPQ 与 JMS 有什么区别知道吗？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%A0%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AF-SpringCloud%EF%BC%8CFeign-%E5%8F%AF%E4%BB%A5%E8%BF%9B%E8%A1%8C%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%98%E8%A6%81%E4%B8%AD%E9%97%B4%E5%8A%A0%E4%B8%80%E4%B8%AA-MQ-%E5%91%A2%EF%BC%9F"><span class="nav-text">你使用的是 SpringCloud，Feign 可以进行远程调用，为什么还要中间加一个 MQ 呢？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MQ-%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BC%98%E5%8A%BF%EF%BC%9F"><span class="nav-text">MQ 有哪些优势？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E6%9C%89%E4%BB%80%E4%B9%88%E7%BC%BA%E7%82%B9%EF%BC%9F"><span class="nav-text">RabbitMQ 有什么缺点？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%A3%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%E4%BB%A5%E4%B8%8A%E7%BC%BA%E7%82%B9%E5%91%A2%EF%BC%9F"><span class="nav-text">那怎么解决以上缺点呢？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E4%BA%8B%E5%8A%A1%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F"><span class="nav-text">RabbitMQ 事务是怎么实现的？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E6%98%AF%E6%80%8E%E4%B9%88%E6%A0%B7%E5%AD%90%E7%9A%84%EF%BC%9F"><span class="nav-text">RabbitMQ 的实现原理是怎么样子的？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%EF%BC%9F"><span class="nav-text">RabbitMQ 有哪些工作模式？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-RPC-%E4%B8%A5%E6%A0%BC%E6%9D%A5%E8%AF%B4%E4%B8%8D%E8%83%BD%E7%AE%97%E6%98%AF-MQ%EF%BC%9F"><span class="nav-text">为什么 RPC 严格来说不能算是 MQ？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%80%8E%E4%B9%88%E8%B7%AF%E7%94%B1%EF%BC%9F"><span class="nav-text">消息怎么路由？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%9F%BA%E4%BA%8E%E4%BB%80%E4%B9%88%E4%BC%A0%E8%BE%93%EF%BC%9F"><span class="nav-text">消息基于什么传输？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%8F%AF%E4%BB%A5%E5%82%A8%E5%AD%98%E6%B6%88%E6%81%AF%E5%90%97%EF%BC%9F"><span class="nav-text">RabbitMQ 中的交换机可以储存消息吗？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E5%91%A2%EF%BC%9F"><span class="nav-text">如何防止消息丢失呢？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%9D%97RabbitMQ-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E5%91%A2%EF%BC%9F"><span class="nav-text">❗RabbitMQ 如何保证消息的可靠性呢？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-TTL%EF%BC%9F%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%EF%BC%8C%E6%B6%88%E6%81%AF%E6%88%90%E4%B8%BA%E6%AD%BB%E4%BF%A1%E6%9C%89%E5%93%AA%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5%EF%BC%9F%E4%BB%80%E4%B9%88%E6%98%AF%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%EF%BC%9F"><span class="nav-text">什么是 TTL？什么是死信队列，消息成为死信有哪几种情况？什么是延迟队列？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%89%E5%87%A0%E7%99%BE%E4%B8%87%E6%B6%88%E6%81%AF%E6%8C%81%E7%BB%AD%E7%A7%AF%E5%8E%8B%E5%87%A0%E5%B0%8F%E6%97%B6%EF%BC%8C%E8%AF%B4%E8%AF%B4%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%EF%BC%9F"><span class="nav-text">有几百万消息持续积压几小时，说说怎么解决？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%BB%A1%E4%BA%86%E4%BB%A5%E5%90%8E%E8%AF%A5%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86"><span class="nav-text">消息队列满了以后该怎么处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E4%B8%8D%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E5%91%A2%EF%BC%9F%E3%80%90%E9%87%8D%E8%A6%81%E3%80%91"><span class="nav-text">RabbitMQ 如何保证消息的不重复消费呢？【重要】</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%BB%B6%E6%97%B6%E4%BB%A5%E5%8F%8A%E8%BF%87%E6%9C%9F%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-text">如何解决消息队列的延时以及过期失效问题？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E8%A6%81%E4%BD%A0%E8%87%AA%E5%B7%B1%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA-MQ%EF%BC%8C%E4%BD%A0%E4%BC%9A%E6%80%8E%E4%B9%88%E8%AE%BE%E8%AE%A1%EF%BC%9F"><span class="nav-text">如果要你自己设计一个 MQ，你会怎么设计？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8-Redis-%E5%AE%9E%E7%8E%B0-MQ-%E5%8A%9F%E8%83%BD%E5%91%A2%EF%BC%9F"><span class="nav-text">怎么使用 Redis 实现 MQ 功能呢？</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2022</span>&nbsp;-&nbsp;2024
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Kiml</a>
        
    </div>

    <div class="theme-info info-item">
        由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    
        <div class="count-info info-item">
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">访客数</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">访问量</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="tools-list border-box">
        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-toggle-theme-mode flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    .zoom-in-image-mask {
  position fixed
  top 0
  right 0
  bottom 0
  left 0
  z-index $z-index-8
  display flex
  align-items center
  justify-content center
  box-sizing border-box
  background rgba(0, 0, 0, 0)
  visibility hidden
  transition-t("visibility, background", "0, 0", "0.3, 0.3", "linear, linear")

  &.show {
    background rgba(0, 0, 0, 0.5)
    visibility visible

    .zoom-in-image {
      cursor zoom-out
    }
  }

  .zoom-in-image {
    position absolute
    z-index $z-index-9
    transform-origin center center
    will-change transform
    transition-t("transform", "0", "0.3", "linear")
  }
}


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <!-- use hexo-blog-encrypt -->
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%A0%E7%9F%A5%E9%81%93%E7%9B%AE%E5%89%8D%E5%B8%82%E9%9D%A2%E4%B8%8A%E4%BD%BF%E7%94%A8%E7%9A%84-MQ-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%90%97%EF%BC%9F"><span class="nav-text">你知道目前市面上使用的 MQ 有哪些吗？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%A0%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AF%E5%93%AA%E7%A7%8D-MQ%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9%E8%BF%99%E7%B1%BB-MQ-qps-%EF%BC%9F"><span class="nav-text">你使用的是哪种 MQ？为什么选择这类 MQ(qps)？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-RabbitMQ%EF%BC%9F"><span class="nav-text">什么是 RabbitMQ？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-AMQP-%E5%8D%8F%E8%AE%AE%EF%BC%9F"><span class="nav-text">什么是 AMQP 协议？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AMPQ-%E4%B8%8E-JMS-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%E7%9F%A5%E9%81%93%E5%90%97%EF%BC%9F"><span class="nav-text">AMPQ 与 JMS 有什么区别知道吗？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%A0%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AF-SpringCloud%EF%BC%8CFeign-%E5%8F%AF%E4%BB%A5%E8%BF%9B%E8%A1%8C%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%98%E8%A6%81%E4%B8%AD%E9%97%B4%E5%8A%A0%E4%B8%80%E4%B8%AA-MQ-%E5%91%A2%EF%BC%9F"><span class="nav-text">你使用的是 SpringCloud，Feign 可以进行远程调用，为什么还要中间加一个 MQ 呢？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MQ-%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BC%98%E5%8A%BF%EF%BC%9F"><span class="nav-text">MQ 有哪些优势？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E6%9C%89%E4%BB%80%E4%B9%88%E7%BC%BA%E7%82%B9%EF%BC%9F"><span class="nav-text">RabbitMQ 有什么缺点？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%A3%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%E4%BB%A5%E4%B8%8A%E7%BC%BA%E7%82%B9%E5%91%A2%EF%BC%9F"><span class="nav-text">那怎么解决以上缺点呢？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E4%BA%8B%E5%8A%A1%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F"><span class="nav-text">RabbitMQ 事务是怎么实现的？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E6%98%AF%E6%80%8E%E4%B9%88%E6%A0%B7%E5%AD%90%E7%9A%84%EF%BC%9F"><span class="nav-text">RabbitMQ 的实现原理是怎么样子的？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%EF%BC%9F"><span class="nav-text">RabbitMQ 有哪些工作模式？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-RPC-%E4%B8%A5%E6%A0%BC%E6%9D%A5%E8%AF%B4%E4%B8%8D%E8%83%BD%E7%AE%97%E6%98%AF-MQ%EF%BC%9F"><span class="nav-text">为什么 RPC 严格来说不能算是 MQ？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%80%8E%E4%B9%88%E8%B7%AF%E7%94%B1%EF%BC%9F"><span class="nav-text">消息怎么路由？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%9F%BA%E4%BA%8E%E4%BB%80%E4%B9%88%E4%BC%A0%E8%BE%93%EF%BC%9F"><span class="nav-text">消息基于什么传输？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%8F%AF%E4%BB%A5%E5%82%A8%E5%AD%98%E6%B6%88%E6%81%AF%E5%90%97%EF%BC%9F"><span class="nav-text">RabbitMQ 中的交换机可以储存消息吗？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E5%91%A2%EF%BC%9F"><span class="nav-text">如何防止消息丢失呢？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%9D%97RabbitMQ-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E5%91%A2%EF%BC%9F"><span class="nav-text">❗RabbitMQ 如何保证消息的可靠性呢？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-TTL%EF%BC%9F%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%EF%BC%8C%E6%B6%88%E6%81%AF%E6%88%90%E4%B8%BA%E6%AD%BB%E4%BF%A1%E6%9C%89%E5%93%AA%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5%EF%BC%9F%E4%BB%80%E4%B9%88%E6%98%AF%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%EF%BC%9F"><span class="nav-text">什么是 TTL？什么是死信队列，消息成为死信有哪几种情况？什么是延迟队列？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%89%E5%87%A0%E7%99%BE%E4%B8%87%E6%B6%88%E6%81%AF%E6%8C%81%E7%BB%AD%E7%A7%AF%E5%8E%8B%E5%87%A0%E5%B0%8F%E6%97%B6%EF%BC%8C%E8%AF%B4%E8%AF%B4%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%EF%BC%9F"><span class="nav-text">有几百万消息持续积压几小时，说说怎么解决？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%BB%A1%E4%BA%86%E4%BB%A5%E5%90%8E%E8%AF%A5%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86"><span class="nav-text">消息队列满了以后该怎么处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E4%B8%8D%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E5%91%A2%EF%BC%9F%E3%80%90%E9%87%8D%E8%A6%81%E3%80%91"><span class="nav-text">RabbitMQ 如何保证消息的不重复消费呢？【重要】</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%BB%B6%E6%97%B6%E4%BB%A5%E5%8F%8A%E8%BF%87%E6%9C%9F%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-text">如何解决消息队列的延时以及过期失效问题？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E8%A6%81%E4%BD%A0%E8%87%AA%E5%B7%B1%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA-MQ%EF%BC%8C%E4%BD%A0%E4%BC%9A%E6%80%8E%E4%B9%88%E8%AE%BE%E8%AE%A1%EF%BC%9F"><span class="nav-text">如果要你自己设计一个 MQ，你会怎么设计？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8-Redis-%E5%AE%9E%E7%8E%B0-MQ-%E5%8A%9F%E8%83%BD%E5%91%A2%EF%BC%9F"><span class="nav-text">怎么使用 Redis 实现 MQ 功能呢？</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>



<!-- common -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/libs/anime.min.js"></script>

<!-- local-search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/lazyload.min.js"></script>


<div class="pjax">
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/post/copyright-info.min.js"></script>
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.1.3/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart()
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd()
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'))
            KEEP.initExecute()
        });
    });
</script>




</body>
</html>
